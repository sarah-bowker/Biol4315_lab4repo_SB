---
title: "lab4_transcriptomics"
author: "Sarah Bowker"
date: "2025-09-25"
output: html_document
---

```{r upload_packages, message=FALSE, warning=FALSE}
BiocManager::install("clusterProfiler")
BiocManager::install("EnhancedVolcano")
#Note, if biomaRt isn't installed on your machine for some reason, you should install it as well. 

lapply(c(
  "docopt", "DT", "pheatmap","GenomicFeatures", "DESeq2",
  "edgeR", "systemPipeR", "systemPipeRdata", "BiocStyle", "GO.db", "dplyr",
  "tidyr", "stringr", "Rqc", "QuasR", "DT", "ape", "clusterProfiler","biomaRt","EnhancedVolcano"
),require, character.only = TRUE) 
```
# Q1. Change the path name and metadata table output

```{r, message=FALSE, warning=FALSE}
# Load required libraries
library(systemPipeRdata)
library(DT)

fq_path <- systemPipeRdata::pathList()$fastqdir

meta_data <- read.table(
  system.file("extdata", "param", "targetsPE.txt", package = "systemPipeRdata"),
  header = TRUE
)

head(meta_data)

meta_data$FileName1 <- file.path(fq_path, basename(meta_data$FileName1))
meta_data$FileName2 <- file.path(fq_path, basename(meta_data$FileName2))

DT::datatable(meta_data, options = list(pageLength = 10))
```

# Q2. Quality check

```{r quality_check, message=FALSE, warning=FALSE}

fastq_files <- c(meta_data$FileName1, meta_data$FileName2)
rqc_result <- Rqc::rqc(path = fq_path, pattern = ".fastq.gz")

rqcCycleQualityBoxPlot(rqc_result[1:12]) + theme_bw()
rqcCycleQualityBoxPlot(rqc_result[13:24]) + theme_bw()
rqcCycleQualityBoxPlot(rqc_result[25:36]) + theme_bw()

rqcCycleBaseCallsPlot(rqc_result[1:12]) + theme_bw()
rqcCycleBaseCallsPlot(rqc_result[13:24]) + theme_bw()
rqcCycleBaseCallsPlot(rqc_result[25:36]) + theme_bw()
```

# Q3. Process Reads
```{r process_reads, message=FALSE, warning=FALSE}
process_reads <- function(fwd_file_path) {
  fq <- readFastq(fwd_file_path)
  adapter_seq <- "GCCCGGGTAA"
  
  fq_trimmed <- trimLRPatterns(Rpattern = adapter_seq, subject = fq)
  
  width_trimmed <- width(fq_trimmed) - 3
  fq_trimmed <- narrow(fq_trimmed, start=1, end=width_trimmed)
  
  seqs <- sread(fq_trimmed)
  n_count <- vcountPattern("N", seqs)
  fq_filtered <- fq_trimmed[n_count <= 1]
  
  base_name <- tools::file_path_sans_ext(basename(fwd_file_path))
  out_file <- file.path("processed_reads", paste0(base_name, "_processed.fastq"))
  
  writeFastq(fq_filtered, out_file, compress = FALSE, mode = "a")
  
  return(out_file)
}


if (!dir.exists("processed_reads")) dir.create("processed_reads")
for (i in seq_len(nrow(meta_data))) {
  old_path <- meta_data$FileName1[i]
  new_path <- process_reads(old_path)
  meta_data$FileName1[i] <- new_path
}
```

# Q4. Align the reads
```{r align_reads, message=FALSE, warning=FALSE}
hisat2_index <- "/Users/sbowker00/Biol4315_lab4repo_SB/hisat2_index/tair10_1_index"

for(i in seq_len(nrow(meta_data))){
  sample_name <- meta_data$SampleName[i]
  fastq_file <- meta_data$FileName1[i]
  
  
  # Create output file paths
  sam_file <- file.path("sam_files", paste0(sample_name, ".sam"))
  bam_file <- file.path("bam_files", paste0(sample_name, ".bam"))
  sorted_bam_file <- file.path("bam_files", paste0(sample_name, "_sorted.bam"))
  log_file <- file.path("bam_files", paste0(sample_name, "_hisat2.log"))
  
  if (!file.exists(fastq_file)) {
    message("Skipping ", sample_name, ": FASTQ not found - ", fastq_file)
    next
  }
  
  # Run HISAT2
  hisat2_log <- tryCatch({
    system2("hisat2", args = c("-x", hisat2_index,
                               "-U", fastq_file,
                               "-p", "8",
                               "-S", sam_file),
            stdout = TRUE, stderr = TRUE)
  }, error = function(e) paste("hisat2 failed:", e$message))
  
  writeLines(hisat2_log, log_file)
  
  # Run samtools
  tryCatch({
    system2("samtools", args = c("view", "-bS", sam_file, "-o", bam_file), stdout = TRUE, stderr = TRUE)
    system2("samtools", args = c("sort", "-o", sorted_bam_file, bam_file), stdout = TRUE, stderr = TRUE)
    system2("samtools", args = c("index", sorted_bam_file), stdout = TRUE, stderr = TRUE)
  }, error = function(e) {
    message("samtools failed for ", sample_name, ": ", e$message)
  })
}
```


# Q5. Alignment stats
```{r read_alignment_stat, message=FALSE, warning=FALSE}
# get the folder
hisat2_logs_dir <- "./bam_files"

# 1. Get a list of all HISAT2 log files
log_files <- list.files(hisat2_logs_dir, pattern = "_hisat2\\.log$", full.names = TRUE)

#preper an "empty" vector of the apropreate size, faster than appending. 
percent_aligned <- 1:length(log_files)

#loop through log files
for (i in seq_along(percent_aligned)) {
  
  percent_aligned[i] <- readLines(log_files[i])[length(readLines(log_files[i]))]
  
}

#bind vectors as dataframe
align_df <- data.frame(sort(meta_data$SampleName),percent_aligned)

# extract the numeric percent value
align_df <- align_df %>% 
  mutate(percent_aligned = as.numeric(
    stringr::str_split_i(align_df$percent_aligned, "%",1))) %>% 
  rename(samplename = sort.meta_data.SampleName.)

DT::datatable(align_df, 
              colnames = c("Sample Name", "Percent Aligned"), 
              options = list(pageLength = 10, autoWidth = TRUE))

ggplot(align_df, aes(x = "", y = percent_aligned)) + 
  geom_boxplot(fill = "pink", color = "darkblue") + 
  labs(title = "Distribution of Alignment Percentages",
       y = "Percent Aligned (%)",
       x = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```

# Q6. Count table
```{r creat_count_table, message=FALSE, warning=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("Rsubread")
library("Rsubread")

bfiles <- list.files("./bam_files", pattern = "_sorted.bam$", full.names = TRUE)

#Counting how many reads corespond to each gene
gene_count_list <- Rsubread::featureCounts(files = bfiles, annot.ext = "GCF_000001735.4_TAIR10.1_genomic.gtf", 
                                           isGTFAnnotationFile = TRUE, # <--- input annotation is GTF
                                           allowMultiOverlap = FALSE,  # <--- don't allow reads that overlap with multiple loci
                                           isPairedEnd = FALSE, nthreads = 8,
                                           minMQS = 10, # <--- minimum mapping quality score of 10 (like a phred score for the hisat2 alignment)
                                           GTF.featureType = "exon",  # <--- Count reads overlapping 'exon' features
                                           GTF.attrType = "gene_id" # <--- Groups exon by gene id
)

# Assigns $count to a variable named count_table.
count_table <- gene_count_list$counts

# Removes the _sort.bam from the column names
colnames(count_table) <- gsub("_sorted\\.bam$", "", colnames(count_table))

# Filter out genes with no reads mapped to them across all samples
count_table <- count_table[rowSums(count_table) > 0, ]

# Uses DT to output the variable an interactive table
DT::datatable(count_table,
              options = list(pageLength = 10, autoWidth = TRUE),
              caption = "Filtered Count Table")
```

# Q7. Analysis
```{r dd2_analysis, message=FALSE, warning=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("DESeq2")
library("DESeq2")
BiocManager::install("SummarizedExperiment")
library("SummarizedExperiment")
library(ape)

#Get the metadata table that would accompany the count table
coldata <- meta_data %>% dplyr::select(SampleName,SampleLong,Factor) %>% 
  dplyr::mutate(SampleLong=str_split_i(SampleLong, "\\.",1)) %>% #getting the groups name (Avirulent, Mock and Virulent)
  dplyr::rename(condition = SampleLong) %>%
  dplyr::mutate(condition = factor(condition)) %>% #for group comp
  dplyr::mutate(Factor = factor(Factor)) #for sample comp

base::rownames(coldata) <- coldata$SampleName
coldata <- coldata %>% mutate(SampleName = factor(SampleName))
coldata$type <- factor(rep("single-read", nrow(coldata)))

#Make sure samples are in the same order between the two. 
coldata <- coldata[base::match(base::colnames(count_table), rownames(coldata)),]
#Check that they are indeed same order
all(rownames(coldata) == base::colnames(count_table))

dds1 <- DESeq2::DESeqDataSetFromMatrix(countData = count_table,
                               colData = coldata,
                               design = ~ condition)
#creating a dds object where the conditions are the samples themslevs 
dds2 <- DESeq2::DESeqDataSetFromMatrix(countData = count_table,
                               colData = coldata,
                               design = ~ Factor)

#correlating the samples
d <- cor(SummarizedExperiment::assay(DESeq2::rlog(dds1)), method = "spearman")
#turning correlation to a distance (1 - correlation) and clustring
hc <- hclust(dist(1 - d))

#hirarchal clustering
plot.phylo(as.phylo(hc), type = "p", edge.col = "blue", edge.width = 2,
           show.node.label = TRUE, no.margin = TRUE)

dds1_results <- DESeq2::DESeq(dds1)
dds2_results <- DESeq2::DESeq(dds2)
res1 <- DESeq2::results(dds1_results)
res1

res2 <- DESeq2::results(dds2_results)
res2

dds2

res_vir_mock <- DESeq2::results(dds1_results, contrast = c("condition", "Vir", "Mock"), alpha = 0.2)

# Avr vs Mock  
res_avr_mock <- DESeq2::results(dds1_results, contrast = c("condition", "Avr", "Mock"), alpha = 0.2)

# Vir vs Avr
res_vir_avr <- DESeq2::results(dds1_results, contrast = c("condition", "Vir", "Avr"), alpha = 0.2)

# Function to filter and count DE genes
filter_and_count <- function(res_obj, comparison_name, fc_threshold = 2) {
  # Remove NAs
  res_filtered <- res_obj[!is.na(res_obj$padj) & !is.na(res_obj$log2FoldChange), ]
  
  # Apply filters: |log2FC| >= log2(2) = 1 and padj <= alpha (already set in results())
  sig_genes <- res_filtered[abs(res_filtered$log2FoldChange) >= log2(fc_threshold), ]
  
  # Count up and down regulated
  up_regulated <- sum(sig_genes$log2FoldChange > 0)
  down_regulated <- sum(sig_genes$log2FoldChange < 0)
  
  return(data.frame(
    Comparison = comparison_name,
    Up_regulated = up_regulated,
    Down_regulated = down_regulated
  ))
}

# Apply filtering and counting to all comparisons
results_summary <- rbind(
  filter_and_count(res_vir_mock, "Vir vs Mock"),
  filter_and_count(res_avr_mock, "Avr vs Mock"),
  filter_and_count(res_vir_avr, "Vir vs Avr")
)

# Print summary
print("Summary of DE genes (FC >= 2, alpha = 0.2):")
print(results_summary)


plot_data <- results_summary %>%
  pivot_longer(cols = c(Up_regulated, Down_regulated), 
               names_to = "Regulation", 
               values_to = "Count") %>%
  mutate(Regulation = factor(Regulation, levels = c("Up_regulated", "Down_regulated")))

# Create horizontal stacked bar plot
p <- ggplot(plot_data, aes(x = Comparison, y = Count, fill = Regulation)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +  # Makes it horizontal
  labs(
    title = "Differentially Expressed Genes by Comparison",
    subtitle = "Fold Change >= 2, alpha = 0.2",
    x = "Comparison",
    y = "Number of Genes",
    fill = "Regulation"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10))
p


# dd2 analysis
comp <- systemPipeR::readComp("/Users/sbowker00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt")
comp[[1]]
pairs_comp <- comp[[1]]
pairs_comp
results_list <- list()
for (pair in pairs_comp) {
  groups <- unlist(strsplit(pair, "-"))
  gr1 <- groups[1]
  gr2 <- groups[2]
  name_comp <- paste(gr1, "vs", gr2)
  res <- DESeq2::results(dds2_results, contrast = c("Factor", gr1, gr2), alpha = 0.2)
  filtered_data <- filter_and_count(res, name_comp)
  results_list[[name_comp]] <- filtered_data
}

results_summary_2 <- do.call(rbind, results_list)

plot_data_2 <- results_summary_2 %>%
  pivot_longer(cols = c(Up_regulated, Down_regulated),
               names_to = "Regulation",
               values_to = "Count") %>%
  mutate(Regulation = factor(Regulation, levels = c("Up_regulated", "Down_regulated")))

p_2 <- ggplot(plot_data_2, aes(x = Comparison, y = Count, fill = Regulation)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  labs(
    title = "Differentially Expressed Genes by Sample Comparison dd2",
    subtitle = "Fold Change >= 2,, alpha = 0.2",
    x = "Comparison",
    y = "Number of Genes",
    fill = "Regulation"
  ) +
  theme_minimal() +
theme(
  plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
  plot.subtitle = element_text(hjust = 0.5, size = 12),
  axis.text = element_text(size = 10),
  axis.title = element_text(size = 12),
  legend.title = element_text(size = 11),
  legend.text = element_text(size = 10))

p_2
```

# Q8. Spearman correlation analysis vs Clustered heatmap based on significant DEGs
```{r , eval=FALSE}
# In the Spearman correlation, we used all genes, and the samples didn’t separate clearly by treatment, suggesting that most genes are not strongly affected by the pathogen. In contrast, clustering based on differentially expressed genes (DEGs) showed that samples grouped much more clearly by treatment, with virulent, avirulent, and mock-treated samples forming more distinct clusters.This makes sense biologically, as DEGs highlight the genes that actually respond to infection, giving a clearer view of how Arabidopsis reacts to different pathogens.
```